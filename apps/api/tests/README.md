# Тесты для Backend API

## Структура тестов

```
tests/
├── setup.ts                    # Настройка тестового окружения
├── helpers/                    # Вспомогательные функции
│   ├── test-app.ts            # Утилиты для создания тестового приложения
│   └── index.ts
├── modules/                    # Тесты модулей
│   ├── auth/
│   │   └── auth.test.ts       # Тесты аутентификации
│   └── services/
│       └── services.test.ts    # Тесты услуг и категорий
├── middleware/                # Тесты middleware
│   ├── auth.middleware.test.ts
│   └── error.middleware.test.ts
└── integration/              # Интеграционные тесты
    └── api.test.ts
```

## Запуск тестов

```bash
# Запустить все тесты
npm test

# Запустить тесты в watch режиме
npm run test:watch

# Запустить тесты с покрытием
npm test -- --coverage

# Запустить конкретный тест
npm test -- auth.test.ts
```

## Настройка окружения

**ВАЖНО**: Для работы тестов требуется настроенная база данных PostgreSQL.

### Шаг 1: Создайте файл `.env.test` в `apps/api/`

```bash
DATABASE_URL=postgresql://user:password@localhost:5432/test_db
JWT_SECRET=test-jwt-secret-key-minimum-32-characters-long-for-testing
JWT_REFRESH_SECRET=test-jwt-refresh-secret-key-minimum-32-characters-long-for-testing
NODE_ENV=test
```

Или используйте переменную `TEST_DATABASE_URL`:

```bash
TEST_DATABASE_URL=postgresql://user:password@localhost:5432/test_db
```

Если `TEST_DATABASE_URL` не установлена, будет использована основная `DATABASE_URL` из `.env`.

### Шаг 2: Создайте тестовую базу данных

```sql
CREATE DATABASE test_db;
```

### Шаг 3: Примените миграции

```bash
cd apps/api
npx prisma migrate deploy
```

### Шаг 4: Запустите тесты

```bash
npm test
```

**Примечание**: Перед каждым тестом база данных автоматически очищается, поэтому можно использовать реальную тестовую БД.

## Что тестируется

### Auth Module
- ✅ Логин с правильными/неправильными данными
- ✅ Обновление токена (refresh)
- ✅ Получение информации о пользователе (me)
- ✅ Выход из системы (logout)
- ✅ Валидация входных данных

### Services Module
- ✅ Получение дерева категорий
- ✅ Получение категории по slug
- ✅ CRUD операции для категорий (требует авторизации)
- ✅ Получение списка услуг с фильтрацией и пагинацией
- ✅ Получение услуги по slug
- ✅ CRUD операции для услуг (требует авторизации)
- ✅ Проверка прав доступа

### Projects Module
- ✅ Получение списка проектов с фильтрацией
- ✅ Получение избранных проектов
- ✅ Получение проекта по slug
- ✅ CRUD операции для проектов (требует авторизации)
- ✅ Фильтрация по категории, типу, стилю
- ✅ Пагинация и сортировка

### Articles Module
- ✅ Получение списка опубликованных статей
- ✅ Получение категорий статей
- ✅ Получение статьи по slug
- ✅ CRUD операции для статей (требует авторизации)
- ✅ Публикация статей
- ✅ Поиск и фильтрация

### Requests Module
- ✅ Создание заявки
- ✅ Заказ обратного звонка
- ✅ Получение списка заявок (админ)
- ✅ Обновление статуса заявки
- ✅ Назначение заявки менеджеру
- ✅ Фильтрация по статусу

### Employees Module
- ✅ Получение списка активных сотрудников
- ✅ Фильтрация по отделу
- ✅ CRUD операции для сотрудников (требует авторизации)

### Reviews Module
- ✅ Получение списка одобренных отзывов
- ✅ Фильтрация по проекту и рейтингу
- ✅ CRUD операции для отзывов (требует авторизации)
- ✅ Одобрение отзывов

### Vacancies Module
- ✅ Получение списка активных вакансий
- ✅ Получение вакансии по ID
- ✅ CRUD операции для вакансий (требует авторизации)
- ✅ Фильтрация по отделу и поиск

### FAQs Module
- ✅ Получение списка активных FAQ
- ✅ Фильтрация по категории
- ✅ CRUD операции для FAQ (требует авторизации)

### Calculator Module
- ✅ Получение конфигурации калькулятора
- ✅ Расчет стоимости ремонта
- ✅ Обновление конфигурации (админ)
- ✅ Валидация входных данных
- ✅ Разные типы ремонта

### Settings Module
- ✅ Получение публичных настроек
- ✅ Получение всех настроек (админ)
- ✅ Фильтрация по группе
- ✅ Обновление настроек

### Media Module
- ✅ Получение списка медиафайлов
- ✅ Фильтрация по папке
- ✅ Получение медиафайла по ID
- ✅ Удаление медиафайлов (требует авторизации)
- ✅ Пагинация

### Middleware
- ✅ Аутентификация (authenticate)
- ✅ Авторизация по ролям (authorize)
- ✅ Обработка ошибок валидации
- ✅ Обработка ошибок Prisma
- ✅ Обработка JWT ошибок
- ✅ Обработка 404 ошибок

### Integration Tests
- ✅ Health check endpoint
- ✅ Полный цикл работы с категориями и услугами
- ✅ Полный цикл аутентификации
- ✅ Пагинация и фильтрация
- ✅ Построение дерева категорий

## Примечания

- Перед каждым тестом база данных очищается
- Тесты используют реальную базу данных (не моки)
- Для тестов создаются временные пользователи, категории и услуги
- Все тесты независимы друг от друга

