/**
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ñ email admineterno@yandex.ru
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: node create-admin-eterno.js
 */

const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcryptjs');

const prisma = new PrismaClient();

// Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
const PASSWORD = 'Adm!n3t3rn0#2024$Secure';

async function createAdminEterno() {
  try {
    console.log('ğŸ”§ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°...\n');

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    try {
      await prisma.$connect();
      console.log('âœ… ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾\n');
    } catch (error) {
      console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error.message);
      console.log('\nğŸ’¡ Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾:');
      console.log('   1. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ°');
      console.log('   2. ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Prisma Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹ (npm run prisma:migrate)');
      console.log('   3. ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾\n');
      process.exit(1);
    }

    // Ğ¥ĞµÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
    const hashedPassword = await bcrypt.hash(PASSWORD, 10);

    console.log('ğŸ“§ Email: admineterno@yandex.ru');
    console.log('ğŸ”‘ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ:', PASSWORD);
    console.log('ğŸ”’ Ğ¥ĞµÑˆ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:', hashedPassword);
    console.log('');

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ email
    let existingUser;
    try {
      existingUser = await prisma.user.findUnique({
        where: {
          email: 'admineterno@yandex.ru',
        },
      });
    } catch (error) {
      if (error.code === 'P2021') {
        console.error('âŒ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° users Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!');
        console.log('\nğŸ’¡ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸:');
        console.log('   npm run prisma:migrate\n');
        process.exit(1);
      }
      throw error;
    }

    if (existingUser) {
      console.log('âš ï¸  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ email ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼...');
      
      // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
      const updatedAdmin = await prisma.user.update({
        where: { id: existingUser.id },
        data: {
          passwordHash: hashedPassword,
          firstName: 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€',
          lastName: 'Eterno',
          role: 'SUPER_ADMIN',
          isActive: true,
        },
      });

      console.log('âœ… ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!');
      console.log('ğŸ“‹ ID:', updatedAdmin.id);
      console.log('ğŸ“§ Email:', updatedAdmin.email);
      console.log('ğŸ‘¤ Ğ˜Ğ¼Ñ:', updatedAdmin.firstName, updatedAdmin.lastName);
      console.log('ğŸ” Ğ Ğ¾Ğ»ÑŒ:', updatedAdmin.role);
    } else {
      // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
      const admin = await prisma.user.create({
        data: {
          email: 'admineterno@yandex.ru',
          passwordHash: hashedPassword,
          firstName: 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€',
          lastName: 'Eterno',
          role: 'SUPER_ADMIN',
          isActive: true,
        },
      });

      console.log('âœ… ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!');
      console.log('ğŸ“‹ ID:', admin.id);
      console.log('ğŸ“§ Email:', admin.email);
      console.log('ğŸ‘¤ Ğ˜Ğ¼Ñ:', admin.firstName, admin.lastName);
      console.log('ğŸ” Ğ Ğ¾Ğ»ÑŒ:', admin.role);
    }

    console.log('');
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
    const testUser = await prisma.user.findUnique({
      where: { email: 'admineterno@yandex.ru' },
    });
    
    if (testUser) {
      const isValid = await bcrypt.compare(PASSWORD, testUser.passwordHash);
      console.log('âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:', isValid ? 'ĞŸĞĞ ĞĞ›Ğ¬ ĞšĞĞ Ğ Ğ•ĞšĞ¢Ğ•Ğ âœ“' : 'ĞĞ¨Ğ˜Ğ‘ĞšĞ! âœ—');
    }

    console.log('');
    console.log('ğŸ‰ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ.');
    console.log('');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ“‹ Ğ”ĞĞĞĞ«Ğ• Ğ”Ğ›Ğ¯ Ğ’Ğ¥ĞĞ”Ğ:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ“§ Email:    admineterno@yandex.ru');
    console.log('ğŸ”‘ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ:   ' + PASSWORD);
    console.log('ğŸ” Ğ Ğ¾Ğ»ÑŒ:     SUPER_ADMIN');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('');
    console.log('âš ï¸  Ğ’ĞĞ–ĞĞ: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ!');
    console.log('');

  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°:', error);
    process.exit(1);
  } finally {
    await prisma.$disconnect();
  }
}

createAdminEterno();
